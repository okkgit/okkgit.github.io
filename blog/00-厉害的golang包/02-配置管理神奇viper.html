<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Viper配置文件工具 | Wayne</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="https://sprintln-1256351233.cos.ap-shanghai.myqcloud.com/img/boy.png">
    <meta name="description" content="Wayne &#39;s Home">
    
    <link rel="preload" href="/assets/css/0.styles.e8e4f3a3.css" as="style"><link rel="preload" href="/assets/js/app.89b597fe.js" as="script"><link rel="preload" href="/assets/js/2.caa3cf16.js" as="script"><link rel="preload" href="/assets/js/14.c33732ac.js" as="script"><link rel="prefetch" href="/assets/js/10.a4342c6e.js"><link rel="prefetch" href="/assets/js/11.adbc1ab8.js"><link rel="prefetch" href="/assets/js/12.1916fed9.js"><link rel="prefetch" href="/assets/js/13.958eb977.js"><link rel="prefetch" href="/assets/js/15.1fd38271.js"><link rel="prefetch" href="/assets/js/16.b244cb9b.js"><link rel="prefetch" href="/assets/js/17.e3aa7611.js"><link rel="prefetch" href="/assets/js/18.ef71013a.js"><link rel="prefetch" href="/assets/js/19.1fc9f3ed.js"><link rel="prefetch" href="/assets/js/20.d72ac13f.js"><link rel="prefetch" href="/assets/js/21.0d2dc834.js"><link rel="prefetch" href="/assets/js/22.2111c89b.js"><link rel="prefetch" href="/assets/js/23.b9ec89f4.js"><link rel="prefetch" href="/assets/js/24.533c4fee.js"><link rel="prefetch" href="/assets/js/25.5db6f758.js"><link rel="prefetch" href="/assets/js/26.dff0c35b.js"><link rel="prefetch" href="/assets/js/27.e4717024.js"><link rel="prefetch" href="/assets/js/28.87ad6896.js"><link rel="prefetch" href="/assets/js/29.e6894a85.js"><link rel="prefetch" href="/assets/js/3.e0f7b2b3.js"><link rel="prefetch" href="/assets/js/30.ebed69b9.js"><link rel="prefetch" href="/assets/js/31.c6fbd67d.js"><link rel="prefetch" href="/assets/js/32.0c758c0b.js"><link rel="prefetch" href="/assets/js/33.2bd59a6a.js"><link rel="prefetch" href="/assets/js/34.afa4eb52.js"><link rel="prefetch" href="/assets/js/35.d95e5d55.js"><link rel="prefetch" href="/assets/js/36.98b78ff6.js"><link rel="prefetch" href="/assets/js/37.944c6d2f.js"><link rel="prefetch" href="/assets/js/38.0fddd6aa.js"><link rel="prefetch" href="/assets/js/39.8244f140.js"><link rel="prefetch" href="/assets/js/4.7e219e85.js"><link rel="prefetch" href="/assets/js/40.de792818.js"><link rel="prefetch" href="/assets/js/41.fe9e28f7.js"><link rel="prefetch" href="/assets/js/42.e859c8fc.js"><link rel="prefetch" href="/assets/js/43.ae498bdf.js"><link rel="prefetch" href="/assets/js/44.8985fc23.js"><link rel="prefetch" href="/assets/js/45.0b4b2d60.js"><link rel="prefetch" href="/assets/js/46.15bee1be.js"><link rel="prefetch" href="/assets/js/47.0aa9d396.js"><link rel="prefetch" href="/assets/js/48.b20f8963.js"><link rel="prefetch" href="/assets/js/49.34c09689.js"><link rel="prefetch" href="/assets/js/5.60c450d9.js"><link rel="prefetch" href="/assets/js/50.37b2e1e1.js"><link rel="prefetch" href="/assets/js/51.36ff241a.js"><link rel="prefetch" href="/assets/js/52.71562ffc.js"><link rel="prefetch" href="/assets/js/53.ac14fdee.js"><link rel="prefetch" href="/assets/js/54.51eba199.js"><link rel="prefetch" href="/assets/js/55.f9cb5357.js"><link rel="prefetch" href="/assets/js/56.9ef945f0.js"><link rel="prefetch" href="/assets/js/57.c9817e05.js"><link rel="prefetch" href="/assets/js/58.4e217863.js"><link rel="prefetch" href="/assets/js/59.abcec551.js"><link rel="prefetch" href="/assets/js/6.d01c1754.js"><link rel="prefetch" href="/assets/js/60.5b811fc0.js"><link rel="prefetch" href="/assets/js/61.e5d4e2bc.js"><link rel="prefetch" href="/assets/js/62.e5b02105.js"><link rel="prefetch" href="/assets/js/63.15653f27.js"><link rel="prefetch" href="/assets/js/64.52ddc8bc.js"><link rel="prefetch" href="/assets/js/65.2d6ae297.js"><link rel="prefetch" href="/assets/js/66.fcc4417c.js"><link rel="prefetch" href="/assets/js/67.31f3dc2f.js"><link rel="prefetch" href="/assets/js/68.f550467a.js"><link rel="prefetch" href="/assets/js/69.4eb7c24f.js"><link rel="prefetch" href="/assets/js/7.fb54d455.js"><link rel="prefetch" href="/assets/js/70.47b71c52.js"><link rel="prefetch" href="/assets/js/71.8dddd648.js"><link rel="prefetch" href="/assets/js/72.afdd7eef.js"><link rel="prefetch" href="/assets/js/73.5516b813.js"><link rel="prefetch" href="/assets/js/74.6d483b53.js"><link rel="prefetch" href="/assets/js/75.cfe3532b.js"><link rel="prefetch" href="/assets/js/76.9982899f.js"><link rel="prefetch" href="/assets/js/77.cf078ba6.js"><link rel="prefetch" href="/assets/js/78.719f8912.js"><link rel="prefetch" href="/assets/js/79.4e51cb16.js"><link rel="prefetch" href="/assets/js/8.9aff31a5.js"><link rel="prefetch" href="/assets/js/80.befcac5e.js"><link rel="prefetch" href="/assets/js/81.851f170f.js"><link rel="prefetch" href="/assets/js/82.2ba9c884.js"><link rel="prefetch" href="/assets/js/83.39c739cf.js"><link rel="prefetch" href="/assets/js/84.b5aeb7fb.js"><link rel="prefetch" href="/assets/js/85.6a5f3fe3.js"><link rel="prefetch" href="/assets/js/86.7045e5df.js"><link rel="prefetch" href="/assets/js/87.0f1f170f.js"><link rel="prefetch" href="/assets/js/88.f37b031c.js"><link rel="prefetch" href="/assets/js/9.ef071d75.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8e4f3a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://sprintln-1256351233.cos.ap-shanghai.myqcloud.com/img/boy.png" alt="Wayne" class="logo"> <span class="site-name can-hide">Wayne</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习笔记" class="mobile-dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/" class="nav-link router-link-active">
  golang学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/coding/" class="nav-link">
  coding
</a></li><li class="dropdown-item"><!----> <a href="/k8s/" class="nav-link">
  k8s学习笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="小成就" class="dropdown-title"><span class="title">小成就</span> <span class="arrow down"></span></button> <button type="button" aria-label="小成就" class="mobile-dropdown-title"><span class="title">小成就</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/story/机器人团队.html" class="nav-link">
  机器人相关
</a></li><li class="dropdown-item"><!----> <a href="/story/公司项目.html" class="nav-link">
  公司项目
</a></li></ul></div></div><div class="nav-item"><a href="/cv/嵌入式.html" class="nav-link">
  我的简历
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习笔记" class="mobile-dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/" class="nav-link router-link-active">
  golang学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/coding/" class="nav-link">
  coding
</a></li><li class="dropdown-item"><!----> <a href="/k8s/" class="nav-link">
  k8s学习笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="小成就" class="dropdown-title"><span class="title">小成就</span> <span class="arrow down"></span></button> <button type="button" aria-label="小成就" class="mobile-dropdown-title"><span class="title">小成就</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/story/机器人团队.html" class="nav-link">
  机器人相关
</a></li><li class="dropdown-item"><!----> <a href="/story/公司项目.html" class="nav-link">
  公司项目
</a></li></ul></div></div><div class="nav-item"><a href="/cv/嵌入式.html" class="nav-link">
  我的简历
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Viper配置文件工具</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#安装" class="sidebar-link">安装</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#配置来源的优先级" class="sidebar-link">配置来源的优先级</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#创建默认值" class="sidebar-link">创建默认值</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#读取配置文件" class="sidebar-link">读取配置文件</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#写入配置文件" class="sidebar-link">写入配置文件</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#可以使用回调函数监听配置文件的修改" class="sidebar-link">可以使用回调函数监听配置文件的修改</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#从io-reader读取配置文件" class="sidebar-link">从io.Reader读取配置文件</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#覆盖设置" class="sidebar-link">覆盖设置</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#注册和使用别名" class="sidebar-link">注册和使用别名</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#使用环境变量" class="sidebar-link">使用环境变量</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#使用flags" class="sidebar-link">使用Flags</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#flag接口-绑定其他flag工具" class="sidebar-link">flag接口，绑定其他flag工具</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#远程key-value存储支持" class="sidebar-link">远程key/value存储支持</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#获取远程配置文件示例" class="sidebar-link">获取远程配置文件示例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#etcd" class="sidebar-link">ETCD</a></li><li class="sidebar-sub-header"><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#consul" class="sidebar-link">Consul</a></li><li class="sidebar-sub-header"><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#firestore" class="sidebar-link">firestore</a></li></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#远程key-value存储示例-加密" class="sidebar-link">远程Key/Value存储示例-加密</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#监控etcd中的更改-未加密" class="sidebar-link">监控etcd中的更改-未加密</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#从viper获取值" class="sidebar-link">从Viper获取值</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#访问嵌套的键值" class="sidebar-link">访问嵌套的键值</a></li><li class="sidebar-sub-header"><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#提取子树" class="sidebar-link">提取子树</a></li><li class="sidebar-sub-header"><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#使用子树" class="sidebar-link">使用子树</a></li></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#反序列化-导出配置" class="sidebar-link">反序列化，导出配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#解析到嵌套结构体" class="sidebar-link">解析到嵌套结构体</a></li></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#序列化成为字符串" class="sidebar-link">序列化成为字符串</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#使用viper较完整的实例" class="sidebar-link">使用Viper较完整的实例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/00-%E5%8E%89%E5%AE%B3%E7%9A%84golang%E5%8C%85/02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E7%A5%9E%E5%A5%87viper.html#gin框架中简单使用viper的实例" class="sidebar-link">gin框架中简单使用viper的实例</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="viper配置文件工具"><a href="#viper配置文件工具" class="header-anchor">#</a> Viper配置文件工具</h1> <p>viper 是go语言完整的配置解决方案，适用所有配置文件类型，总之很强</p> <ul><li>支持默认值</li> <li>JSON、TOML、YAML、HCL......等格式配置文件</li> <li>读取环境变量，远程配置系统（ETCD或Consul）,命令行,buffer</li> <li>显示配置信息</li></ul> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">go</span> get github<span class="token punctuation">.</span>com<span class="token operator">/</span>spf13<span class="token operator">/</span>viper
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="配置来源的优先级"><a href="#配置来源的优先级" class="header-anchor">#</a> 配置来源的优先级</h2> <ul><li>配置优先级从高到低
<ul><li>显示调用Set设置值</li> <li>命令行参数（flag）</li> <li>环境变量</li> <li>配置文件</li> <li>key/value存储</li> <li>默认值</li></ul></li></ul> <h2 id="创建默认值"><a href="#创建默认值" class="header-anchor">#</a> 创建默认值</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">&quot;ContentDir&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">&quot;LayoutDir&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;layouts&quot;</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">&quot;Taxonomies&quot;</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;tag&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;tags&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;category&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;categories&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="读取配置文件"><a href="#读取配置文件" class="header-anchor">#</a> 读取配置文件</h2> <p>使用Viper搜索和读取配置文件的示例。不需要任何特定的路径，但是至少应该提供一个配置文件预期出现的路径。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token string">&quot;./config.yaml&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 制定配置文件的路径</span>
viper<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">&quot;config&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 配置文件名称(无扩展名)</span>
viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">&quot;yaml&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 如果配置文件的名称中没有扩展名，则需要配置此项</span>

<span class="token comment">// 多次调用查找配置文件</span>
viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">&quot;/etc/appname/&quot;</span><span class="token punctuation">)</span>   <span class="token comment">// 查找配置文件所在的路径</span>
viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">&quot;$HOME/.appname&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// 多次调用以添加多个搜索路径</span>
viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>               <span class="token comment">// 还可以在工作目录中查找配置</span>

<span class="token comment">// 查找读取配置文件</span>
err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 查找并读取配置文件</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// 处理读取配置文件的错误</span>
	<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Fatal error config file: %s \n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>通过下面方法查找制定目录的制定名字（不包含后缀）的配置文件</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">&quot;config&quot;</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">&quot;./conf&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>处理找不到文件的特定情况</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span>ConfigFileNotFoundError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        <span class="token comment">// 配置文件未找到错误；如果需要可以忽略</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 配置文件被找到，但产生了另外的错误</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="写入配置文件"><a href="#写入配置文件" class="header-anchor">#</a> 写入配置文件</h2> <p>针对在运行是需要修改配置文件的需求。</p> <ul><li>WriteConfig 将当前viper配置写入预定义目录, 如果不存在报错</li> <li>SafeWriteConfig 同上，不存在也报错，但存在的话并不会覆盖</li> <li>WriteConfigAs 当前配置写入制定路径，存在则覆盖</li> <li>SafeWriteConfigAs 同上，但不会覆盖</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>iper<span class="token punctuation">.</span><span class="token function">WriteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 将当前配置写入“viper.AddConfigPath()”和“viper.SetConfigName”设置的预定义路径</span>
viper<span class="token punctuation">.</span><span class="token function">SafeWriteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">WriteConfigAs</span><span class="token punctuation">(</span><span class="token string">&quot;/path/to/my/.config&quot;</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SafeWriteConfigAs</span><span class="token punctuation">(</span><span class="token string">&quot;/path/to/my/.config&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 因为该配置文件写入过，所以会报错</span>
viper<span class="token punctuation">.</span><span class="token function">SafeWriteConfigAs</span><span class="token punctuation">(</span><span class="token string">&quot;/path/to/my/.other_config&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="可以使用回调函数监听配置文件的修改"><a href="#可以使用回调函数监听配置文件的修改" class="header-anchor">#</a> 可以使用回调函数监听配置文件的修改</h2> <ul><li>需要再调用WatchConfig() 方法之前，已经分配了配置文件的路径</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">WatchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">OnConfigChange</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>e fsnotify<span class="token punctuation">.</span>Event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Config file changed:&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="从io-reader读取配置文件"><a href="#从io-reader读取配置文件" class="header-anchor">#</a> 从io.Reader读取配置文件</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">&quot;yaml&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 或者 viper.SetConfigType(&quot;YAML&quot;)</span>

<span class="token comment">// 任何需要将此配置添加到程序中的方法。</span>
<span class="token keyword">var</span> yamlExample <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`
Hacker: true
name: steve
hobbies:
- skateboarding
- snowboarding
- go
clothing:
  jacket: leather
  trousers: denim
age: 35
eyes : brown
beard: true
`</span><span class="token punctuation">)</span>

viper<span class="token punctuation">.</span><span class="token function">ReadConfig</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>yamlExample<span class="token punctuation">)</span><span class="token punctuation">)</span>

viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 这里会得到 &quot;steve&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="覆盖设置"><a href="#覆盖设置" class="header-anchor">#</a> 覆盖设置</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;Verbose&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;LogFile&quot;</span><span class="token punctuation">,</span> LogFile<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="注册和使用别名"><a href="#注册和使用别名" class="header-anchor">#</a> 注册和使用别名</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">RegisterAlias</span><span class="token punctuation">(</span><span class="token string">&quot;loud&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Verbose&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// 注册别名（此处loud和Verbose建立了别名）</span>

viper<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;verbose&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 结果与下一行相同</span>
viper<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;loud&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>   <span class="token comment">// 结果与前一行相同</span>

viper<span class="token punctuation">.</span><span class="token function">GetBool</span><span class="token punctuation">(</span><span class="token string">&quot;loud&quot;</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
viper<span class="token punctuation">.</span><span class="token function">GetBool</span><span class="token punctuation">(</span><span class="token string">&quot;verbose&quot;</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="使用环境变量"><a href="#使用环境变量" class="header-anchor">#</a> 使用环境变量</h2> <ul><li>Viper将ENV变量视为区分大小写</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token function">SetEnvPrefix</span><span class="token punctuation">(</span><span class="token string">&quot;spf&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 将自动转为大写</span>
<span class="token function">BindEnv</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span>

os<span class="token punctuation">.</span><span class="token function">Setenv</span><span class="token punctuation">(</span><span class="token string">&quot;SPF_ID&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;13&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 通常是在应用程序之外完成的</span>

id <span class="token operator">:=</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 13</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="使用flags"><a href="#使用flags" class="header-anchor">#</a> 使用Flags</h2> <ul><li>Viper 具有绑定到标志的能力。具体来说，Viper支持Cobra库中使用的Pflag。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>serverCmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token number">1138</span><span class="token punctuation">,</span> <span class="token string">&quot;Port to run Application server on&quot;</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">BindPFlag</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> serverCmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>直接使用已经绑定好的 Cobra库中Pflag</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>pflag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">&quot;flagname&quot;</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">,</span> <span class="token string">&quot;help message for flagname&quot;</span><span class="token punctuation">)</span>

pflag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">BindPFlags</span><span class="token punctuation">(</span>pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span>

i <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token string">&quot;flagname&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 从viper而不是从pflag检索值</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>在 Viper 中使用 pflag 并不阻碍其他包中使用标准库中的 flag 包。pflag 包可以通过导入这些 flags 来处理flag包定义的flags。这是通过调用pflag包提供的便利函数AddGoFlagSet()来实现的。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;flag&quot;</span>
	<span class="token string">&quot;github.com/spf13/pflag&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// 使用标准库 &quot;flag&quot; 包</span>
	flag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">&quot;flagname&quot;</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">,</span> <span class="token string">&quot;help message for flagname&quot;</span><span class="token punctuation">)</span>

	pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">AddGoFlagSet</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span>
	pflag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	viper<span class="token punctuation">.</span><span class="token function">BindPFlags</span><span class="token punctuation">(</span>pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span>

	i <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token string">&quot;flagname&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 从 viper 检索值</span>

	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="flag接口-绑定其他flag工具"><a href="#flag接口-绑定其他flag工具" class="header-anchor">#</a> flag接口，绑定其他flag工具</h2> <ul><li>FlagValue表示单个flag。这是一个关于如何实现这个接口的非常简单的例子</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 一个实现接口的flag函数签名</span>
<span class="token keyword">type</span> myFlag <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f myFlag<span class="token punctuation">)</span> <span class="token function">HasChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f myFlag<span class="token punctuation">)</span> <span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">&quot;my-flag-name&quot;</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f myFlag<span class="token punctuation">)</span> <span class="token function">ValueString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">&quot;my-flag-value&quot;</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f myFlag<span class="token punctuation">)</span> <span class="token function">ValueType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>实现这个接口后，很容易绑定到viper</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">BindFlagValue</span><span class="token punctuation">(</span><span class="token string">&quot;my-flag-name&quot;</span><span class="token punctuation">,</span> myFlag<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>FlagValueSet代表一组 flags 。这是一个关于如何实现这个接口的非常简单的例子:</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> myFlagSet <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	flags <span class="token punctuation">[</span><span class="token punctuation">]</span>myFlag
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f myFlagSet<span class="token punctuation">)</span> <span class="token function">VisitAll</span><span class="token punctuation">(</span>fn <span class="token keyword">func</span><span class="token punctuation">(</span>FlagValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> flag <span class="token operator">:=</span> <span class="token keyword">range</span> flags <span class="token punctuation">{</span>
		<span class="token function">fn</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>实现 FlagValueSet 接口来后将一组flags注册到Viper</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>fSet <span class="token operator">:=</span> myFlagSet <span class="token punctuation">{</span>
    flags<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>myFlag<span class="token punctuation">{</span>myFlag<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> myFlag<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
viper<span class="token punctuation">.</span><span class="token function">BindFlagValues</span><span class="token punctuation">(</span><span class="token string">&quot;my-flags&quot;</span><span class="token punctuation">,</span> fSet<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="远程key-value存储支持"><a href="#远程key-value存储支持" class="header-anchor">#</a> 远程key/value存储支持</h2> <ul><li>在Viper中启用远程支持，需要在代码中匿名导入viper/remote这个包。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token boolean">_</span> <span class="token string">&quot;github.com/spf13/viper/remote&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>Viper将读取从Key/Value存储（例如etcd或Consul）中的路径检索到的配置字符串（如JSON、TOML、YAML、HCL、envfile和Java properties格式）</li> <li>注意配置的优先级：
<ul><li>磁盘上的配置文件&gt;命令行标志位&gt;环境变量&gt;远程Key/Value存储&gt;默认值</li></ul></li> <li>Viper使用crypt从K/V存储中检索配置，这意味着如果你有正确的gpg密匙，你可以将配置值加密存储并自动解密。加密是可选的。</li> <li>你可以将远程配置与本地配置结合使用，也可以独立使用。</li> <li>crypt有一个命令行助手，你可以使用它将配置放入K/V存储中。crypt默认使用在http://127.0.0.1:4001的etcd。</li></ul> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>go get github.com/bketelsen/crypt/bin/crypt
crypt <span class="token builtin class-name">set</span> <span class="token parameter variable">-plaintext</span> /config/hugo.json /Users/hugo/settings/config.json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="获取远程配置文件示例"><a href="#获取远程配置文件示例" class="header-anchor">#</a> 获取远程配置文件示例</h2> <h3 id="etcd"><a href="#etcd" class="header-anchor">#</a> ETCD</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">AddRemoteProvider</span><span class="token punctuation">(</span><span class="token string">&quot;etcd&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://127.0.0.1:4001&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/config/hugo.json&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 因为在字节流中没有文件扩展名，所以这里需要设置下类型。</span>
<span class="token comment">// 支持的扩展名有 &quot;json&quot;, &quot;toml&quot;, &quot;yaml&quot;, &quot;yml&quot;, </span>
<span class="token comment">// &quot;properties&quot;, &quot;props&quot;, &quot;prop&quot;, &quot;env&quot;, &quot;dotenv&quot;</span>
viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">&quot;json&quot;</span><span class="token punctuation">)</span> 
err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="consul"><a href="#consul" class="header-anchor">#</a> Consul</h3> <ul><li>需要 Consul Key/Value存储中设置一个Key保存包含所需配置的JSON值。例如，创建一个keyMY_CONSUL_KEY将下面的值存入Consul key/value 存储：</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;port&quot;</span><span class="token punctuation">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>
    <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;enc&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">AddRemoteProvider</span><span class="token punctuation">(</span><span class="token string">&quot;consul&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;localhost:8500&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;MY_CONSUL_KEY&quot;</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">&quot;json&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 需要显示设置成json</span>
err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 8080</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// enc</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="firestore"><a href="#firestore" class="header-anchor">#</a> firestore</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">AddRemoteProvider</span><span class="token punctuation">(</span><span class="token string">&quot;firestore&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;google-cloud-project-id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;collection/document&quot;</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">&quot;json&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 配置的格式: &quot;json&quot;, &quot;toml&quot;, &quot;yaml&quot;, &quot;yml&quot;</span>
err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="远程key-value存储示例-加密"><a href="#远程key-value存储示例-加密" class="header-anchor">#</a> 远程Key/Value存储示例-加密</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">AddSecureRemoteProvider</span><span class="token punctuation">(</span><span class="token string">&quot;etcd&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;http://127.0.0.1:4001&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/config/hugo.json&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/etc/secrets/mykeyring.gpg&quot;</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">&quot;json&quot;</span><span class="token punctuation">)</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="监控etcd中的更改-未加密"><a href="#监控etcd中的更改-未加密" class="header-anchor">#</a> 监控etcd中的更改-未加密</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 或者你可以创建一个新的viper实例</span>
<span class="token keyword">var</span> runtime_viper <span class="token operator">=</span> viper<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

runtime_viper<span class="token punctuation">.</span><span class="token function">AddRemoteProvider</span><span class="token punctuation">(</span><span class="token string">&quot;etcd&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://127.0.0.1:4001&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/config/hugo.yml&quot;</span><span class="token punctuation">)</span>
runtime_viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">&quot;yaml&quot;</span><span class="token punctuation">)</span> 

<span class="token comment">// 第一次从远程读取配置</span>
err <span class="token operator">:=</span> runtime_viper<span class="token punctuation">.</span><span class="token function">ReadRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 反序列化</span>
runtime_viper<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>runtime_conf<span class="token punctuation">)</span>

<span class="token comment">// 开启一个单独的goroutine一直监控远端的变更</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
	    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">// 每次请求后延迟一下</span>

	    <span class="token comment">// 目前只测试了etcd支持</span>
	    err <span class="token operator">:=</span> runtime_viper<span class="token punctuation">.</span><span class="token function">WatchRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	        log<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to read remote config: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	        <span class="token keyword">continue</span>
	    <span class="token punctuation">}</span>

	    <span class="token comment">// 将新配置反序列化到我们运行时的配置结构体中。你还可以借助channel实现一个通知系统更改的信号</span>
	    runtime_viper<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>runtime_conf<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="从viper获取值"><a href="#从viper获取值" class="header-anchor">#</a> 从Viper获取值</h2> <ul><li>根据获取值类型不同使用以下方法
|函数签名|返回值类型|
|-|-|
|Get(key string) | interface{}|
|GetBool(key string) | bool|
|GetFloat64(key string) | float64|
|GetInt(key string) | int|
|GetIntSlice(key string) | []int|
|GetString(key string) | string|
|GetStringMap(key string) | map[string]interface{}|
|GetStringMapString(key string) | map[string]string|
|GetStringSlice(key string) | []string|
|GetTime(key string) | time.Time|
|GetDuration(key string) | time.Duration|
|IsSet(key string) | bool|
|AllSettings() | map[string]interface{}|</li></ul> <p>::: warring</p> <ul><li>GET系方法在找不到值时会返回对应的零值</li> <li>判断是否存在需要使用 <code>IsSet()</code>方法
:::</li></ul> <h3 id="访问嵌套的键值"><a href="#访问嵌套的键值" class="header-anchor">#</a> 访问嵌套的键值</h3> <ul><li>例如json可能对象套对象的格式</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;host&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">8080</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>这时候访问port既可以使用</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>vipper<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token string">&quot;host.port&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="提取子树"><a href="#提取子树" class="header-anchor">#</a> 提取子树</h3> <ul><li>有如下 yaml 配置文件</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">app</span><span class="token punctuation">:</span>
    <span class="token key atrule">cache1</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-items</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token key atrule">item-size</span><span class="token punctuation">:</span> <span class="token number">64</span>
    <span class="token key atrule">cache2</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-items</span><span class="token punctuation">:</span> <span class="token number">200</span>
        <span class="token key atrule">item-size</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>获取子树</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>subv <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">&quot;app.cache1&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><code>subv</code>这个时候就是代表对应子树</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">max-items</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span class="token key atrule">item-size</span><span class="token punctuation">:</span> <span class="token number">64</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="使用子树"><a href="#使用子树" class="header-anchor">#</a> 使用子树</h3> <p>针对如下创建缓存的函数，并且输入参数是 基于subv格式的</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewCache</span><span class="token punctuation">(</span>cfg <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token operator">*</span>Cache <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>使用子树就可以轻松创建多个不同配置的缓存了</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>cfg1 <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">&quot;app.cache1&quot;</span><span class="token punctuation">)</span>
cache1 <span class="token operator">:=</span> <span class="token function">NewCache</span><span class="token punctuation">(</span>cfg1<span class="token punctuation">)</span>

cfg2 <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">&quot;app.cache2&quot;</span><span class="token punctuation">)</span>
cache2 <span class="token operator">:=</span> <span class="token function">NewCache</span><span class="token punctuation">(</span>cfg2<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="反序列化-导出配置"><a href="#反序列化-导出配置" class="header-anchor">#</a> 反序列化，导出配置</h2> <ul><li>可以将配置的值或部分值值解析到结构体、map等。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 两个方法实现</span>
<span class="token function">Unmarshal</span><span class="token punctuation">(</span>rawVal <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token builtin">error</span>
<span class="token function">UnmarshalKey</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> rawVal <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token builtin">error</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>栗子</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Port <span class="token builtin">int</span>
	Name <span class="token builtin">string</span>
	PathMap <span class="token builtin">string</span> <span class="token string">`mapstructure:&quot;path_map&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> C config

err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>C<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to decode into struct, %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>修改键分隔符（解决想要键值内本身村在<code>.</code>的情况）</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>v <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">NewWithOptions</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">KeyDelimiter</span><span class="token punctuation">(</span><span class="token string">&quot;::&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

v<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">&quot;chart::values&quot;</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
    <span class="token string">&quot;ingress&quot;</span><span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token string">&quot;annotations&quot;</span><span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
            <span class="token string">&quot;traefik.frontend.rule.type&quot;</span><span class="token punctuation">:</span>                 <span class="token string">&quot;PathPrefix&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;traefik.ingress.kubernetes.io/ssl-redirect&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Chart <span class="token keyword">struct</span><span class="token punctuation">{</span>
        Values <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> C config

v<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>C<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="解析到嵌套结构体"><a href="#解析到嵌套结构体" class="header-anchor">#</a> 解析到嵌套结构体</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">/*
Example config:

module:
    enabled: true
    token: 89h3f98hbwf987h3f98wenf89ehf
*/</span>
<span class="token keyword">type</span> config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Module <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		Enabled <span class="token builtin">bool</span>

		moduleConfig <span class="token string">`mapstructure:&quot;,squash&quot;`</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// moduleConfig could be in a module specific package</span>
<span class="token keyword">type</span> moduleConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Token <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> C config

err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>C<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to decode into struct, %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="序列化成为字符串"><a href="#序列化成为字符串" class="header-anchor">#</a> 序列化成为字符串</h2> <ul><li>选用自定义的格式化器与 <code>AllSettings()</code>方法一起使用</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">import</span> yaml

<span class="token keyword">func</span> <span class="token function">yamlStringSetting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    c <span class="token operator">=</span> viper<span class="token punctuation">.</span><span class="token function">AllSetting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    bs<span class="token punctuation">,</span> err <span class="token operator">:=</span> yaml<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bs
<span class="token punctuation">}</span>

## 使用多个Viper实例
<span class="token operator">-</span> 一般默认viper使用的是类似单例模式
<span class="token operator">-</span> 如果用户需要使用不同多套的配置则可以手动创建实例
~~~<span class="token keyword">go</span>
a <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
b <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">&quot;usernae&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">&quot;usernae&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="使用viper较完整的实例"><a href="#使用viper较完整的实例" class="header-anchor">#</a> 使用Viper较完整的实例</h2> <ul><li>存在config.yaml配置文件</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8123</span>
<span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;v1.2.3&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="gin框架中简单使用viper的实例"><a href="#gin框架中简单使用viper的实例" class="header-anchor">#</a> gin框架中简单使用viper的实例</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;net/http&quot;</span>

    <span class="token string">&quot;github.com/gin-gonic/gin&quot;</span>
    <span class="token string">&quot;github.com/spf13/viper&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token string">&quot;config.yaml&quot;</span><span class="token punctuation">)</span>
    viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token comment">// 指定查找配置文件的目录</span>
    err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;配置文件读取失败, err%s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 开启监控配置文件变化</span>
    Viper<span class="token punctuation">.</span><span class="token function">WatchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// gin框架helloworld</span>
    r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/version&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">&quot;version&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>
		fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;:%d&quot;</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

### 使用中可能会用先加载到本地结构体中
~~~<span class="token keyword">go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>

	<span class="token string">&quot;github.com/fsnotify/fsnotify&quot;</span>

	<span class="token string">&quot;github.com/gin-gonic/gin&quot;</span>
	<span class="token string">&quot;github.com/spf13/viper&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Port    <span class="token builtin">int</span>    <span class="token string">`mapstructure:&quot;port&quot;`</span>
	Version <span class="token builtin">string</span> <span class="token string">`mapstructure:&quot;version&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> Conf <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Config<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token string">&quot;./conf/config.yaml&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 指定配置文件路径</span>
	err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token comment">// 读取配置信息</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                           <span class="token comment">// 读取配置信息失败</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Fatal error config file: %s \n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 将读取的配置信息保存至全局变量Conf</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>Conf<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unmarshal conf failed, err:%s \n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 监控配置文件变化</span>
	viper<span class="token punctuation">.</span><span class="token function">WatchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 注意！！！配置文件发生变化后要同步到全局变量Conf</span>
	viper<span class="token punctuation">.</span><span class="token function">OnConfigChange</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>in fsnotify<span class="token punctuation">.</span>Event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;夭寿啦~配置文件被人修改啦...&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>Conf<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unmarshal conf failed, err:%s \n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 访问/version的返回值会随配置文件的变化而变化</span>
	r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/version&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> Conf<span class="token punctuation">.</span>Version<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;:%d&quot;</span><span class="token punctuation">,</span> Conf<span class="token punctuation">.</span>Port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.89b597fe.js" defer></script><script src="/assets/js/2.caa3cf16.js" defer></script><script src="/assets/js/14.c33732ac.js" defer></script>
  </body>
</html>
